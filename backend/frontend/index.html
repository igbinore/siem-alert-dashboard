<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SIEM Alert Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap (for quick layout) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { padding: 20px; }
    .card { border-radius: 16px; }
    .table-wrap { max-height: 400px; overflow:auto; }
    .badge { font-size: .8rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-3">SIEM Alert Dashboard</h1>
    <p class="text-muted">Live data from <code>http://127.0.0.1:8000</code></p>

    <!-- Filters -->
    <div class="row g-2 mb-3">
      <div class="col-12 col-md-2">
        <select id="vendor" class="form-select">
          <option value="">Vendor: All</option>
          <option>Microsoft Defender</option>
          <option>Elastic</option>
          <option>Splunk</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <select id="severity" class="form-select">
          <option value="">Severity: All</option>
          <option>Low</option>
          <option>Medium</option>
          <option>High</option>
          <option>Critical</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <select id="status" class="form-select">
          <option value="">Status: All</option>
          <option>new</option>
          <option>in_progress</option>
          <option>closed</option>
        </select>
      </div>
      <div class="col-12 col-md-3">
        <input id="q" class="form-control" placeholder="Search summary/user/tags…" />
      </div>
      <div class="col-12 col-md-3 d-grid">
        <button id="apply" class="btn btn-primary">Apply Filters</button>
      </div>
    </div>

    <!-- KPI cards -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="text-muted small">Total Alerts</div>
            <div id="kpi-total" class="h3 mb-0">—</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="text-muted small">Top Severity</div>
            <div id="kpi-top-sev" class="h3 mb-0">—</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="text-muted small">Top Vendor</div>
            <div id="kpi-top-vendor" class="h3 mb-0">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="card-title">Alerts by Severity</h6>
            <canvas id="sevChart" height="220"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6 class="card-title">Alerts by Vendor</h6>
            <canvas id="vendorChart" height="220"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title">Alert Feed</h6>
        <div class="table-wrap">
          <table class="table table-sm align-middle">
            <thead class="table-light sticky-top">
              <tr>
                <th>ID</th><th>Time</th><th>Vendor</th><th>Severity</th>
                <th>Type</th><th>User</th><th>Status</th><th>Summary</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
const API = "http://127.0.0.1:8000";

const els = {
  kpiTotal: document.getElementById("kpi-total"),
  kpiTopSev: document.getElementById("kpi-top-sev"),
  kpiTopVendor: document.getElementById("kpi-top-vendor"),
  rows: document.getElementById("rows"),
  vendor: document.getElementById("vendor"),
  severity: document.getElementById("severity"),
  status: document.getElementById("status"),
  q: document.getElementById("q"),
  apply: document.getElementById("apply")
};

let sevChart, vendorChart;

function topKey(obj){
  let maxK = "—", maxV = -1;
  for (const [k,v] of Object.entries(obj||{})){
    if (v > maxV) { maxV = v; maxK = k; }
  }
  return maxK === "—" ? "—" : `${maxK} (${maxV})`;
}

async function loadSummary(){
  const r = await fetch(`${API}/summary`);
  const j = await r.json();
  els.kpiTotal.textContent = j.total ?? 0;
  els.kpiTopSev.textContent = topKey(j.by_severity);
  els.kpiTopVendor.textContent = topKey(j.by_vendor);

  const sevLabels = Object.keys(j.by_severity||{});
  const sevValues = Object.values(j.by_severity||{});
  const vendorLabels = Object.keys(j.by_vendor||{});
  const vendorValues = Object.values(j.by_vendor||{});

  // severity chart
  if (sevChart) sevChart.destroy();
  sevChart = new Chart(document.getElementById("sevChart"), {
    type: "doughnut",
    data: { labels: sevLabels, datasets: [{ data: sevValues }] },
    options: { plugins: { legend: { position: "bottom" } } }
  });

  // vendor chart
  if (vendorChart) vendorChart.destroy();
  vendorChart = new Chart(document.getElementById("vendorChart"), {
    type: "bar",
    data: { labels: vendorLabels, datasets: [{ data: vendorValues }] },
    options: {
      scales: { y: { beginAtZero: true, precision: 0 } },
      plugins: { legend: { display: false } }
    }
  });
}

function badge(text, cls){
  return `<span class="badge bg-${cls}">${text}</span>`;
}

function sevBadge(sev){
  const map = { Low: "secondary", Medium: "info", High: "warning", Critical: "danger" };
  return badge(sev, map[sev] || "secondary");
}

function statusBadge(s){
  const map = { new: "primary", in_progress: "warning", closed: "success" };
  return badge(s, map[s] || "secondary");
}

async function loadAlerts(){
  const params = new URLSearchParams();
  if (els.vendor.value) params.set("vendor", els.vendor.value);
  if (els.severity.value) params.set("severity", els.severity.value);
  if (els.status.value) params.set("status", els.status.value);
  if (els.q.value) params.set("q", els.q.value);

  const r = await fetch(`${API}/alerts?${params.toString()}`);
  const j = await r.json();

  els.rows.innerHTML = j.map(a => `
    <tr>
      <td>${a.id}</td>
      <td>${new Date(a.timestamp).toLocaleString()}</td>
      <td>${a.vendor}</td>
      <td>${sevBadge(a.severity)}</td>
      <td>${a.detection_type}</td>
      <td>${a.username}</td>
      <td>${statusBadge(a.status)}</td>
      <td>${a.summary}</td>
    </tr>
  `).join("");
}

document.addEventListener("DOMContentLoaded", async () => {
  await loadSummary();
  await loadAlerts();
  els.apply.addEventListener("click", async () => {
    await loadAlerts();
  });
});
</script>
</body>
</html>
