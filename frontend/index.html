<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SIEM Alert Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { padding: 20px; }
    .card { border-radius: 16px; }
    .table-wrap { max-height: 400px; overflow: auto; }
    .badge { font-size: .8rem; }
    /* Hide manager-only sections when role is analyst */
    body[data-role="analyst"] .role-manager { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-3">SIEM Alert Dashboard</h1>
    <p class="text-muted">Live data from <code>http://127.0.0.1:8000</code></p>

    <!-- Filters -->
    <div class="row g-2 mb-3">
      <div class="col-12 col-md-2">
        <select id="vendor" class="form-select" aria-label="Filter by Vendor">
          <option value="">Vendor: All</option>
          <option>Microsoft Defender</option>
          <option>Elastic</option>
          <option>Splunk</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <select id="detection_type" class="form-select" aria-label="Filter by Detection Type">
          <option value="">Detection: All</option>
          <option>Suspicious PowerShell</option>
          <option>Brute Force</option>
          <option>DLP</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <select id="severity" class="form-select" aria-label="Filter by Severity">
          <option value="">Severity: All</option>
          <option>Low</option>
          <option>Medium</option>
          <option>High</option>
          <option>Critical</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <select id="status" class="form-select" aria-label="Filter by Status">
          <option value="">Status: All</option>
          <option>new</option>
          <option>in_progress</option>
          <option>closed</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <input id="q" class="form-control" placeholder="Search summary/user/tags…" aria-label="Free text search" />
      </div>

      <div class="col-6 col-md-1 d-grid">
        <button id="apply" class="btn btn-primary">Apply</button>
      </div>
      <div class="col-6 col-md-1 d-grid">
        <button id="export" class="btn btn-outline-secondary role-manager">Export</button>
      </div>
      <div class="col-6 col-md-2 d-grid">
        <button id="reset" class="btn btn-light">Reset</button>
      </div>

      <!-- Role toggle -->
      <div class="col-12 col-md-3 d-flex align-items-center gap-3">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="role" id="roleAnalyst" value="analyst" checked>
          <label class="form-check-label" for="roleAnalyst">Analyst</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="role" id="roleManager" value="manager">
          <label class="form-check-label" for="roleManager">Manager</label>
        </div>
      </div>
    </div>

    <!-- KPI cards (Manager only) -->
    <div class="row g-3 mb-3 role-manager">
      <div class="col-12 col-md-4">
        <div class="card shadow-sm"><div class="card-body">
          <div class="text-muted small">Total Alerts</div>
          <div id="kpi-total" class="h3 mb-0">—</div>
        </div></div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card shadow-sm"><div class="card-body">
          <div class="text-muted small">Top Severity</div>
          <div id="kpi-top-sev" class="h3 mb-0">—</div>
        </div></div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card shadow-sm"><div class="card-body">
          <div class="text-muted small">Top Vendor</div>
          <div id="kpi-top-vendor" class="h3 mb-0">—</div>
        </div></div>
      </div>
    </div>

    <!-- Charts (Manager only) -->
    <div class="row g-3 mb-4 role-manager">
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm"><div class="card-body">
          <h6 class="card-title">Alerts by Severity</h6>
          <canvas id="sevChart" height="220"></canvas>
        </div></div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm"><div class="card-body">
          <h6 class="card-title">Alerts by Vendor</h6>
          <canvas id="vendorChart" height="220"></canvas>
        </div></div>
      </div>
    </div>

    <!-- Table -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title d-flex align-items-center gap-2">
          Alert Feed
          <span id="result-count" class="badge bg-dark">0</span>
        </h6>
        <div class="table-wrap">
          <table class="table table-sm align-middle">
            <thead class="table-light sticky-top">
              <tr>
                <th>ID</th><th>Time</th><th>Vendor</th><th>Severity</th>
                <th>Type</th><th>User</th><th>Status</th><th>Summary</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
const API = "http://127.0.0.1:8000";

const els = {
  // KPI & chart
  kpiTotal: document.getElementById("kpi-total"),
  kpiTopSev: document.getElementById("kpi-top-sev"),
  kpiTopVendor: document.getElementById("kpi-top-vendor"),
  // Table
  rows: document.getElementById("rows"),
  resultCount: document.getElementById("result-count"),
  // Filters
  vendor: document.getElementById("vendor"),
  detection: document.getElementById("detection_type"),
  severity: document.getElementById("severity"),
  status: document.getElementById("status"),
  q: document.getElementById("q"),
  // Buttons
  apply: document.getElementById("apply"),
  exportBtn: document.getElementById("export"),
  reset: document.getElementById("reset"),
  // Role radios
  roleAnalyst: document.getElementById("roleAnalyst"),
  roleManager: document.getElementById("roleManager")
};

let sevChart, vendorChart;

function topKey(obj){
  let maxK = "—", maxV = -1;
  for (const [k,v] of Object.entries(obj||{})){
    if (v > maxV) { maxV = v; maxK = k; }
  }
  return maxK === "—" ? "—" : `${maxK} (${maxV})`;
}

async function loadSummary(){
  const r = await fetch(`${API}/summary`);
  const j = await r.json();

  // KPIs
  els.kpiTotal.textContent = j.total ?? 0;
  els.kpiTopSev.textContent = topKey(j.by_severity);
  els.kpiTopVendor.textContent = topKey(j.by_vendor);

  const sevLabels = Object.keys(j.by_severity||{});
  const sevValues = Object.values(j.by_severity||{});
  const vendorLabels = Object.keys(j.by_vendor||{});
  const vendorValues = Object.values(j.by_vendor||{});

  // Charts
  if (sevChart) sevChart.destroy();
  sevChart = new Chart(document.getElementById("sevChart"), {
    type: "doughnut",
    data: { labels: sevLabels, datasets: [{ data: sevValues }] },
    options: { plugins: { legend: { position: "bottom" } } }
  });

  if (vendorChart) vendorChart.destroy();
  vendorChart = new Chart(document.getElementById("vendorChart"), {
    type: "bar",
    data: { labels: vendorLabels, datasets: [{ data: vendorValues }] },
    options: {
      scales: { y: { beginAtZero: true, precision: 0 } },
      plugins: { legend: { display: false } }
    }
  });
}

function badge(text, cls){ return `<span class="badge bg-${cls}">${text}</span>`; }
function sevBadge(sev){ const m={Low:"secondary",Medium:"info",High:"warning",Critical:"danger"}; return badge(sev,m[sev]||"secondary"); }
function statusBadge(s){ const m={new:"primary",in_progress:"warning",closed:"success"}; return badge(s,m[s]||"secondary"); }

function currentParams(){
  const p = new URLSearchParams();
  if (els.vendor.value) p.set("vendor", els.vendor.value);
  if (els.detection.value) p.set("detection_type", els.detection.value);
  if (els.severity.value) p.set("severity", els.severity.value);
  if (els.status.value) p.set("status", els.status.value);
  if (els.q.value) p.set("q", els.q.value);
  return p.toString();
}

async function loadAlerts(){
  const r = await fetch(`${API}/alerts?${currentParams()}`);
  const j = await r.json();

  els.resultCount.textContent = j.length;
  if (!j.length){
    els.rows.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">No results for current filters</td></tr>`;
    return;
  }

  els.rows.innerHTML = j.map(a => `
    <tr>
      <td>${a.id}</td>
      <td>${new Date(a.timestamp).toLocaleString()}</td>
      <td>${a.vendor}</td>
      <td>${sevBadge(a.severity)}</td>
      <td>${a.detection_type}</td>
      <td>${a.username}</td>
      <td>${statusBadge(a.status)}</td>
      <td>${a.summary}</td>
    </tr>
  `).join("");
}

function applyRole(role){
  document.body.setAttribute("data-role", role);
  try { localStorage.setItem("siem_role", role); } catch {}
}

function initRole(){
  let role = "analyst";
  try { role = localStorage.getItem("siem_role") || role; } catch {}
  if (role === "manager") {
    els.roleManager.checked = true;
  } else {
    els.roleAnalyst.checked = true;
  }
  applyRole(role);
}

function resetFilters(){
  els.vendor.value = "";
  els.detection.value = "";
  els.severity.value = "";
  els.status.value = "";
  els.q.value = "";
}

document.addEventListener("DOMContentLoaded", async () => {
  initRole();

  await loadSummary();
  await loadAlerts();

  els.apply.addEventListener("click", loadAlerts);
  els.exportBtn.addEventListener("click", () => {
    const qs = currentParams();
    window.location.href = `${API}/export?${qs}`;
  });
  els.reset.addEventListener("click", async () => {
    resetFilters();
    await loadAlerts();
  });
  els.q.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); loadAlerts(); }
  });

  els.roleAnalyst.addEventListener("change", () => applyRole("analyst"));
  els.roleManager.addEventListener("change", () => applyRole("manager"));
});
</script>
</body>
</html>
